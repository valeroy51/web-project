{% extends "base.html" %}
{% block title %}Analisis Data{% endblock %}
{% block content %}

<div class="max-w-7xl mx-auto px-6 py-12">
  <h1 class="text-3xl font-bold mb-2">Analisis Data</h1>
  <p class="text-gray-600 mb-8">
    Dashboard analitik kualitas udara berbasis <i>Indeks Standar Pencemar Udara (ISPU)</i> untuk data prediksi dan
    aktual.
  </p>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-10">
    {% for c in cards %}
    <div class="
      relative p-5 rounded-xl border shadow-sm 
      transition duration-300 hover:shadow-md hover:-translate-y-0.5
      {% cycle 'bg-yellow-50 border-yellow-100' 'bg-green-50 border-green-100' 'bg-amber-50 border-amber-100' 'bg-teal-50 border-teal-100' %}
    ">
      <div class="flex justify-between items-start">
        <h4 class="font-semibold text-gray-800 flex items-center gap-2">
          <span>{{ c.icon }}</span> {{ c.title }}
        </h4>
        <span class="text-xl font-bold text-blue-700">{{ c.value }}</span>
      </div>
      <p class="text-sm text-gray-600 mt-2">{{ c.desc }}</p>
    </div>
    {% endfor %}
  </div>


  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10 items-start">

    <div class="p-6 bg-white rounded-xl shadow border relative flex flex-col justify-between h-[460px]">
      <div>
        <h2 class="font-semibold text-lg mb-3">ISPU Prediksi per Polutan</h2>

        <div class="absolute top-5 right-5">
          <select id="predStationSelector"
            class="border border-gray-300 rounded-md bg-white text-sm px-3 py-1.5 shadow-sm focus:ring-2 focus:ring-blue-400">
            <option value="avg">Rata-rata Semua Stasiun</option>
          </select>
        </div>

        <div class="relative h-[340px] mt-2">
          <canvas id="ispuPredChart" class="w-full h-full"></canvas>
        </div>
      </div>

      <p class="text-xs text-gray-500 mt-3">
        Warna batang mengikuti kategori ISPU: Baik (â‰¤50), Sedang (â‰¤100), Tidak Sehat (â‰¤200), Sangat Tidak Sehat (â‰¤300),
        Berbahaya (>300).
      </p>
    </div>

    <div class="p-6 bg-white rounded-xl shadow border relative flex flex-col justify-between h-[460px]">
      <div>
        <h2 class="font-semibold text-lg mb-3">ISPU Aktual per Polutan (Rata-rata Tanggal Terbaru)</h2>

        <div class="relative h-[340px] mt-2">
          <canvas id="ispuActualChart" class="w-full h-full"></canvas>
        </div>
      </div>

      <p class="text-xs text-gray-500 mt-3">
        Diambil dari <i>MapView</i> (tanggal terbaru per stasiun), dirata-ratakan antar stasiun.
      </p>
    </div>

  </div>


  <div class="p-6 bg-white rounded-xl shadow border mb-10">
    <h2 class="font-semibold text-lg mb-5">Matriks Korelasi Parameter (Spearman)</h2>
    <p class="text-sm text-gray-600 mb-4">
      Warna menunjukkan kekuatan dan arah hubungan antar parameter berdasarkan hasil analisis korelasi.
    </p>

    <canvas id="heatmapChart" height="350" style="max-height: 400px; width: 100%;"></canvas>

    <div class="mt-5 text-xs text-gray-600">
      <p><b>Keterangan warna:</b> ðŸ”´ Positif kuat &nbsp;&nbsp; âšª Lemah / Tidak ada &nbsp;&nbsp; ðŸ”µ Negatif kuat</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>

{{ ispu_labels|json_script:"ispu-labels" }}
{{ ispu_values_avg|json_script:"ispu-values-avg" }}
{{ ispu_station_data|json_script:"ispu-station-data" }}

{{ bar_labels|json_script:"bar-labels" }}
{{ bar_actual_ispu|json_script:"bar-actual-ispu" }}

{{ heatmap_data|json_script:"heatmap-data" }}



<script>
  function colorForISPU(v) {
    if (v <= 50) return '#16a34a';
    if (v <= 100) return '#15b5fa';
    if (v <= 200) return '#fab515';
    if (v <= 300) return '#fa1515';
    return '#0a0a0a';
  }

  const ispuLabels = JSON.parse(document.getElementById('ispu-labels').textContent);
  const ispuValuesAvg = JSON.parse(document.getElementById('ispu-values-avg').textContent);
  const ispuStationData = JSON.parse(document.getElementById('ispu-station-data').textContent);

  const predSelector = document.getElementById('predStationSelector');
  Object.keys(ispuStationData).sort().forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    predSelector.appendChild(opt);
  });

  const ctxPred = document.getElementById('ispuPredChart');
  const predConfig = {
    type: 'bar',
    data: {
      labels: ispuLabels,
      datasets: [{
        label: 'ISPU Prediksi',
        data: ispuValuesAvg,
        backgroundColor: ispuValuesAvg.map(colorForISPU),
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          top: 30
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: (ctx) => `ISPU: ${ctx.parsed.y}` }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Parameter Polutan' } },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Nilai ISPU' },
          suggestedMax: 300
        }
      }
    }
  };
  const predChart = new Chart(ctxPred, predConfig);

  predSelector.addEventListener('change', (e) => {
    const key = e.target.value;
    const values = (key === 'avg') ? ispuValuesAvg : ispuStationData[key] || ispuValuesAvg;
    predChart.data.datasets[0].data = values;
    predChart.data.datasets[0].backgroundColor = values.map(colorForISPU);
    predChart.update();
  });

  const barLabels = JSON.parse(document.getElementById('bar-labels').textContent);
  const barActualISPU = JSON.parse(document.getElementById('bar-actual-ispu').textContent);

  new Chart(document.getElementById('ispuActualChart'), {
    type: 'bar',
    data: {
      labels: barLabels,
      datasets: [{
        label: 'ISPU Aktual (Rata-rata)',
        data: barActualISPU,
        backgroundColor: barActualISPU.map(colorForISPU),
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx) => `ISPU: ${ctx.parsed.y}` } }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Nilai ISPU' }, suggestedMax: 300 },
        x: { title: { display: true, text: 'Parameter Polutan' } }
      }
    }
  });

  const ctxHeat = document.getElementById('heatmapChart').getContext('2d');
  const matrixData = JSON.parse(document.getElementById('heatmap-data').textContent);

  const polutans = [...new Set(matrixData.map(d => d.y))];
  const meteos = [...new Set(matrixData.map(d => d.x))];

  const polutanDisplayName = {
    pm10: "PMâ‚â‚€",
    pm25: "PMâ‚‚.â‚…",
    so2: "SOâ‚‚",
    co: "CO",
    o3: "Oâ‚ƒ",
    no2: "NOâ‚‚"
  };

  const formattedData = [];
  polutans.forEach((pol, i) => {
    meteos.forEach((met, j) => {
      const found = matrixData.find(d => d.x === met && d.y === pol);
      formattedData.push({
        x: j,
        y: i,
        v: found ? found.v : 0,
        xLabel: met,
        yLabel: pol
      });
    });
  });

  new Chart(ctxHeat, {
    type: 'matrix',
    data: {
      datasets: [{
        data: formattedData,
        borderWidth: 1,
        borderColor: 'rgba(255,255,255,0.6)',
        backgroundColor(ctx) {
          const v = ctx.raw.v;
          const t = (v + 1) / 2;
          const r = t < 0.5 ? Math.round(2 * t * 255) : 255;
          const g = t < 0.5 ? Math.round(2 * t * 255) : Math.round(255 * (1 - 2 * (t - 0.5)));
          const b = t < 0.5 ? 255 : Math.round(255 * (1 - 2 * (t - 0.5)));
          return `rgba(${r}, ${g}, ${b}, 0.9)`;
        },
        width: ctx => ctx.chart.chartArea ? (ctx.chart.chartArea.width / meteos.length) * 0.9 : 0,
        height: ctx => ctx.chart.chartArea ? (ctx.chart.chartArea.height / polutans.length) * 0.9 : 0,
      }]
    },
    options: {
      maintainAspectRatio: false,
      layout: { padding: { top: 30, left: 50, right: 20, bottom: 10 } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: items => `${items[0].raw.yLabel} Ã— ${items[0].raw.xLabel}`,
            label: item => `r = ${item.raw.v.toFixed(2)}`
          }
        },
      },
      scales: {
        x: { type: 'linear', position: 'top', min: -0.5, max: meteos.length - 0.5, ticks: { display: false }, grid: { display: false } },
        y: { type: 'linear', reverse: true, min: -0.5, max: polutans.length - 0.5, ticks: { display: false }, grid: { display: false } }
      }
    },
    plugins: [{
      id: 'label-centering',
      afterDraw(chart) {
        const ctx = chart.ctx;
        const { x, y } = chart.scales;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#222';

        ctx.font = 'bold 15px sans-serif';

        meteos.forEach((label, i) => {
          const words = label.split(" ");
          const half = Math.ceil(words.length / 2);
          const line1 = words.slice(0, half).join(" ");
          const line2 = words.slice(half).join(" ");

          const xPos = x.getPixelForValue(i);

          const yPos = x.top - 15;

          ctx.fillText(line1, xPos, yPos);
          ctx.fillText(line2, xPos, yPos + 15);
        });

        polutans.forEach((label, j) => {
          const xPos = x.left - 30;
          const yPos = y.getPixelForValue(j);
          ctx.fillText(polutanDisplayName[label] || label, xPos, yPos);
        });

        chart.data.datasets[0].data.forEach(point => {
          const xPos = x.getPixelForValue(point.x);
          const yPos = y.getPixelForValue(point.y);
          ctx.fillText(point.v.toFixed(2), xPos, yPos);
        });

        ctx.restore();
      }
    }]

  });
</script>

{% endblock %}