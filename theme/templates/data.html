{% extends "base.html" %}
{% block title %}Input Data{% endblock %}
{% block content %}
{% load static %}

<div id="messages-container">
  {% if messages %}
  {% for message in messages %}
  <div class="p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-100 border border-green-300" role="alert">
    {{ message }}
  </div>
  {% endfor %}
  {% endif %}
</div>



<div class="max-w-7xl mx-auto px-6 py-12 space-y-10">
  <header>
    <h1 class="text-3xl font-bold">Input Data</h1>
    <p class="text-gray-600">Masukkan data polutan dan meteorologi untuk monitoring kualitas udara</p>
  </header>

  <div class="relative flex bg-gray-100 rounded-full border border-gray-300 shadow-sm overflow-hidden text-center">
    <button id="manualBtn"
      class="flex-1 py-3 font-medium transition rounded-full border border-transparent bg-white text-blue-600 shadow-sm z-10">
      Input Manual
    </button>
    <button id="uploadBtn"
      class="flex-1 py-3 font-medium transition rounded-full border border-transparent text-gray-600 hover:text-blue-600">
      Upload File
    </button>
  </div>

  <div id="manualForm" class="grid lg:grid-cols-2 gap-8 mt-6 items-stretch">


    <form method="POST"
      class="flex flex-col justify-between bg-white p-8 rounded-2xl border border-gray-300 shadow-sm space-y-6">

      {% csrf_token %}
      <h2 class="font-semibold text-xl text-gray-800 mb-3">üß™ Input Data Polutan</h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Stasiun Monitoring</label>
          {{ polutan_form.station }}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">PM<sub>10</sub></label>
            {{ polutan_form.pm10 }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">PM<sub>2.5</sub></label>
            {{ polutan_form.pm25 }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">SO<sub>2</sub></label>
            {{ polutan_form.so2 }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">CO</label>
            {{ polutan_form.co }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">O<sub>3</sub></label>
            {{ polutan_form.o3 }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">NO<sub>2</sub></label>
            {{ polutan_form.no2 }}
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Waktu Pengukuran</label>
          {{ polutan_form.tanggal }}
        </div>
      </div>

      <button type="submit" name="save_pollutant"
        class="w-full bg-blue-700 hover:bg-blue-800 text-white font-medium px-4 py-2.5 rounded-lg shadow-sm transition">
        + Simpan Data Polutan
      </button>
    </form>

    <form method="POST" class="bg-white p-8 rounded-2xl border border-gray-300 shadow-sm space-y-6">
      {% csrf_token %}
      <h2 class="font-semibold text-xl text-gray-800 mb-3">üå¶Ô∏è Input Data Meteorologi</h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Stasiun Monitoring</label>
          {{ meteo_form.station }}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Temperatur Minimum (¬∞C)</label>
            {{ meteo_form.temperatur_minimum }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Temperatur Maksimum (¬∞C)</label>
            {{ meteo_form.temperatur_maksimum }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Temperatur Rata(¬∞C)</label>
            {{ meteo_form.temperatur_rata }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Kelembapan Rata (%)</label>
            {{ meteo_form.kelembapan_rata }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Curah Hujan (mm)</label>
            {{ meteo_form.curah_hujan }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Kecepatan Angin Maks (m/s)</label>
            {{ meteo_form.kecepatan_angin_maksimum }}
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Kecepatan Angin Rata (m/s)</label>
            {{ meteo_form.kecepatan_angin_rata }}
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Waktu Pengukuran</label>
          {{ meteo_form.tanggal }}
        </div>
      </div>

      <button type="submit" name="save_meteo"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2.5 rounded-lg shadow-sm transition">
        + Simpan Data Meteorologi
      </button>
    </form>
  </div>


  <div id="uploadForm" class="hidden mt-6 space-y-8">
    <div class="grid lg:grid-cols-2 gap-8">
      <div class="bg-white p-6 rounded-xl border shadow-sm">
        <form method="POST" enctype="multipart/form-data" id="uploadFormTag">
          {% csrf_token %}
          <h2 class="font-semibold text-lg mb-4">Upload File Data</h2>

          <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center">
            <p class="text-gray-600">Upload File CSV atau Excel</p>
            <p class="text-gray-500 text-sm mb-4">Pilih file lalu klik tombol upload di bawah</p>

            <label
              class="inline-block bg-gray-800 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-black transition">
              Pilih File
              <input type="file" name="upload_file" accept=".csv,.xlsx,.xls" id="fileInput" class="hidden">
            </label>

            <p id="selectedFileName" class="mt-3 text-sm text-blue-600 font-medium"></p>

            <p class="text-xs text-gray-500 mt-3">Format: CSV, XLSX, XLS (maks. 10MB per file)</p>
          </div>

          <button type="submit" name="upload"
            class="mt-4 bg-blue-700 hover:bg-blue-800 text-white font-medium px-4 py-2 rounded-lg w-full">
            Upload File
          </button>
        </form>
      </div>
      <div class="bg-white p-6 rounded-xl border shadow-sm">
        <h2 class="font-semibold text-lg mb-3 text-center">File yang Diupload</h2>

        {% if upload_history %}
        <ul class="space-y-2 text-sm">
          {% for file in upload_history %}
          <li class="p-2 border rounded-lg bg-gray-50 flex items-center justify-between">
            <span>üìÇ {{ file.name }}</span>
            <span class="{% if file.type == 'polutan' %}text-blue-600{% else %}text-green-600{% endif %} font-semibold">
              {{ file.type|capfirst }}
            </span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-500 text-sm text-center">Belum ada file yang diupload</p>
        {% endif %}
      </div>

      <div class="bg-white p-6 rounded-xl border shadow-sm flex flex-col justify-between">
        <div>
          <h2 class="font-semibold text-lg mb-2">üîÑ Gabungkan Data</h2>
          <p class="text-gray-600 text-sm mb-4">
            Gabungkan data polutan & meteorologi yang sudah diupload menjadi satu dataset siap latih.
          </p>
        </div>

        <form method="post" action="{% url 'merge' %}">
          {% csrf_token %}
          <button class="w-full bg-blue-700 hover:bg-blue-800 text-white py-2.5 rounded-lg font-medium transition">
            Merge Data Sekarang
          </button>
        </form>
      </div>

      <div class="bg-white p-6 rounded-xl border shadow-sm flex flex-col justify-between">
        <div>
          <h2 class="font-semibold text-lg mb-2">‚è≥ Jadwalkan Pelatihan Model</h2>
          <p class="text-gray-600 text-sm mb-4">
            Atur kapan sistem akan menjalankan pelatihan ulang model MSSA.
          </p>
        </div>

        <form id="scheduleForm" method="post" action="{% url 'schedule_train' %}">
          {% csrf_token %}
          <input type="hidden" id="tz_offset" name="tz_offset">

          <label class="font-medium text-sm text-gray-700">Pilih Waktu</label>
          <input type="datetime-local" name="schedule_time" class="border rounded-lg p-2 w-full mt-2" required>

          <button class="w-full mt-4 bg-blue-700 hover:bg-blue-800 text-white py-2.5 rounded-lg font-medium transition">
            Jadwalkan Pelatihan Model
          </button>
        </form>
      </div>
    </div>
  </div>



  <div class="bg-white p-6 rounded-xl border shadow-sm">
    <h2 class="font-semibold text-lg mb-4">Template File</h2>
    <div class="grid lg:grid-cols-2 gap-6">

      <div class="border rounded-lg p-4">
        <h3 class="font-medium mb-1">Template Data Polutan</h3>
        <p class="text-sm text-gray-600 mb-3">
          Format: Tanggal, Station, PM<sub>10</sub>, PM<sub>2.5</sub>, SO<sub>2</sub>, CO, O<sub>3</sub>, NO<sub>2</sub>
        </p>
        <a href="{% static 'Nama_Stasiun_Polutan.xlsx' %}" download
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm">
          üì• Download Template
        </a>
      </div>

      <div class="border rounded-lg p-4">
        <h3 class="font-medium mb-1">Template Data Meteorologi</h3>
        <p class="text-sm text-gray-600 mb-3">
          Format: Tanggal, Stasiun, TN (Temperatur Minimum), TX (Temperatur Maksimum), TAVG (Temperatur Rata Rata),
          RH_AVG (Suhu Rata Rata), RR (Curah Hujan), FF_X (Kecepatan Angin Maksimum), FF_AVG (Kecepatan Angin Rata Rata)
        </p>
        <a href="{% static 'Nama_Stasiun_Meteorologi.xlsx' %}" download
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm">
          üì• Download Template
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  const manualBtn = document.getElementById("manualBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const manualForm = document.getElementById("manualForm");
  const uploadForm = document.getElementById("uploadForm");

  function setActive(activeBtn, inactiveBtn, showForm, hideForm) {
    activeBtn.classList.add("bg-white", "text-blue-600", "shadow-sm", "border", "border-gray-300");
    inactiveBtn.classList.remove("bg-white", "text-blue-600", "shadow-sm", "border", "border-gray-300");
    inactiveBtn.classList.add("text-gray-600");
    showForm.classList.remove("hidden");
    hideForm.classList.add("hidden");
  }

  manualBtn.addEventListener("click", () => {
    setActive(manualBtn, uploadBtn, manualForm, uploadForm);
  });

  uploadBtn.addEventListener("click", () => {
    setActive(uploadBtn, manualBtn, uploadForm, manualForm);
  });

  setTimeout(() => {
    document.querySelectorAll('[role="alert"]').forEach(el => el.remove());
  }, 4000);


  document.getElementById('fileInput').addEventListener('change', function (e) {
    const fileName = e.target.files[0]?.name || "";
    document.getElementById('selectedFileName').textContent = fileName
      ? `üìÑ ${fileName}`
      : "";
  });
</script>

<script>
  document.getElementById("tz_offset").value = new Date().getTimezoneOffset();
</script>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrfToken = getCookie('csrftoken');
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector('#train-form');
    const container = document.querySelector('#messages-container');

    form.addEventListener('submit', function () {
      const waitingMsg = document.createElement('div');
      waitingMsg.className = "p-3 mb-4 rounded bg-blue-100 text-blue-800";
      waitingMsg.innerText = "Mohon ditunggu, saat ini model sedang dilakukan pembelajaran ulang...";

      container.prepend(waitingMsg);

      form.querySelector('button').disabled = true;
    });
  });
</script>


{% if active_tab == "upload" %}
<script>
  window.addEventListener("load", () => {
    setActive(uploadBtn, manualBtn, uploadForm, manualForm);
  });
</script>
{% endif %}

{% endblock %}