{% extends "base.html" %}
{% block title %}Beranda{% endblock %}

{% block content %}
<section class="py-10 px-4 md:px-10 bg-gray-50 min-h-screen">

  <div class="max-w-6xl mx-auto mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
      Peta Kualitas Udara DKI Jakarta
    </h1>
    <p class="text-gray-600 mt-1">
      Monitoring real-time kualitas udara di seluruh wilayah DKI Jakarta
    </p>
  </div>

  <div class="max-w-6xl mx-auto grid lg:grid-cols-3 gap-6 items-stretch">
    <div class="lg:col-span-2 bg-white shadow rounded-2xl p-4">
      <div class="relative h-[640px] rounded-xl overflow-hidden bg-blue-50">
        <div id="map" class="absolute inset-0 w-full h-full rounded-xl"></div>
      </div>
    </div>

    <div class="flex flex-col justify-between space-y-4">
      <div id="station-detail">
        <div id="default-panel"
          class="bg-white shadow rounded-2xl p-6 text-center border-dashed border-2 border-gray-200 min-h-[300px] flex flex-col justify-center">
          <div class="text-pink-500 text-4xl mb-2">üìç</div>
          <h3 class="font-semibold text-gray-700">Pilih Stasiun</h3>
          <p class="text-sm text-gray-500 mt-1">
            Klik pada titik di peta untuk melihat detail stasiun monitoring dan akses prediksi
          </p>
        </div>
      </div>

      <div id="daily-summary" class="bg-white shadow rounded-2xl p-6">
        <h3 class="font-semibold text-gray-800 mb-3">Ringkasan Hari Ini</h3>
        <div class="flex justify-between text-sm mb-1">
          <span class="text-gray-500">Rata - Rata Status ISPU</span>
          <span class="font-semibold">{{ agv_status|default:"Baik" }}</span>
        </div>
        <div class="flex justify-between text-sm mb-1">
          <span class="text-gray-500">Kualitas Udara Terbaik</span>
          <span class="font-semibold text-green-600">Stasiun {{ best_station|default:"-" }}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-500">Kualitas Udara Terbur uk</span>
          <span class="font-semibold text-red-600">Stasiun {{ worst_station|default:"-" }}</span>
        </div>
      </div>
    </div>
  </div>


  <div class="max-w-6xl mx-auto mt-10">
    <div class="bg-white shadow rounded-2xl p-6">
      <h3 class="font-semibold text-gray-800 mb-2">Status Real-time</h3>
      <p class="text-sm text-gray-500 mb-4">
        Distribusi status kualitas udara saat ini di seluruh stasiun monitoring DKI Jakarta
      </p>
      <div class="grid md:grid-cols-5 sm:grid-cols-3 gap-3 text-center">
        <div class="rounded-xl p-4 bg-green-50 border border-green-100">
          <p class="text-3xl font-bold text-green-600">{{ realtime.Baik }}</p>
          <p class="text-sm text-gray-600">Baik<br><span class="text-xs">(0-50 ISPU)</span></p>
        </div>
        <div class="rounded-xl p-4 bg-blue-50 border border-blue-100">
          <p class="text-3xl font-bold text-blue-600">{{ realtime.Sedang }}</p>
          <p class="text-sm text-gray-600">Sedang<br><span class="text-xs">(51-100 ISPU)</span></p>
        </div>
        <div class="rounded-xl p-4 bg-orange-50 border border-orange-100">
          <p class="text-3xl font-bold text-orange-500">{{ realtime.Tidak_Sehat }}</p>
          <p class="text-sm text-gray-600">Tidak Sehat<br><span class="text-xs">(101-200 ISPU)</span></p>
        </div>
        <div class="rounded-xl p-4 bg-red-50 border border-red-100">
          <p class="text-3xl font-bold text-red-500">{{ realtime.Sangat_Tidak_Sehat }}</p>
          <p class="text-sm text-gray-600">Sangat Tidak Sehat<br><span class="text-xs">(201-300 ISPU)</span></p>
        </div>
        <div class="rounded-xl p-4 bg-black/5 border border-gray-200">
          <p class="text-3xl font-bold text-gray-800">{{ realtime.Berbahaya }}</p>
          <p class="text-sm text-gray-600">Berbahaya<br><span class="text-xs">(301+ ISPU)</span></p>
        </div>
      </div>
      <p class="text-xs text-gray-400 mt-4">Diperbarui: hari ini</p>
    </div>
  </div>

</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  .custom-legend {
    font-family: 'Inter', sans-serif;
    backdrop-filter: blur(4px);
  }
</style>

<script>
  var map = L.map('map').setView([-6.2, 106.8], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  const legend = L.control({ position: 'bottomleft' });
  legend.onAdd = function (map) {
    const div = L.DomUtil.create('div', 'bg-white/90 rounded-lg shadow p-3 text-sm leaflet-control custom-legend');
    div.innerHTML = `
        <h3 class="font-semibold mb-1">Indeks Kualitas Udara</h3>
        <ul class="text-xs space-y-1">
          <li><span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>Baik (0-50)</li>
          <li><span class="inline-block w-3 h-3 bg-blue-500 rounded-full mr-2"></span>Sedang (51-100)</li>
          <li><span class="inline-block w-3 h-3 bg-orange-400 rounded-full mr-2"></span>Tidak Sehat (101-200)</li>
          <li><span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>Sangat Tidak Sehat (201-300)</li>
          <li><span class="inline-block w-3 h-3 bg-black rounded-full mr-2"></span>Berbahaya (301+)</li>
        </ul>
      `;
    return div;
  };
  legend.addTo(map);

  const stations = JSON.parse(`{{ stations_json|safe }}`);


  stations.forEach(s => {
    const marker = L.circleMarker(s.coords, {
      color: 'white',
      fillColor: s.color,
      fillOpacity: 0.9,
      radius: 9,
      weight: 2
    }).addTo(map);

    const radiusCircle = L.circle(s.coords, {
    radius: 5000,
    color: "purple",
    weight: 1.5,
    fillOpacity: 0.08,
    dashArray: "4 6",
    interactive: false 
  }).addTo(map);

    marker.on("click", () => showStationDetail(s));
  });

function showStationDetail(s) {
  const container = document.getElementById("station-detail");
  const summary = document.getElementById("daily-summary");
  summary.style.display = "block";

  function kategori_ispu(nilai) {
    if (nilai <= 50) return "Baik";
    if (nilai <= 100) return "Sedang";
    if (nilai <= 200) return "Tidak Sehat";
    if (nilai <= 300) return "Sangat Tidak Sehat";
    return "Berbahaya";
  }

  function warna_status(nilai) {
    const status = kategori_ispu(nilai);
    return (
      status === "Baik" ? "bg-green-500" :
      status === "Sedang" ? "bg-blue-600" :
      status === "Tidak Sehat" ? "bg-orange-500" :
      status === "Sangat Tidak Sehat" ? "bg-red-500" :
      "bg-black"
    );
  }

  const gridHTML = Object.entries(s.data).map(([key, val]) => {
    const nilai = parseFloat(val) || 0;
    const warna = warna_status(nilai);
    const label = key.replace("_", ".");
    return `
      <div class="${warna} text-white rounded-lg py-2 font-semibold shadow-sm">
        ${label}<br><span class="font-normal">${val}</span>
      </div>`;
  }).join("");

  let borderColor =
    s.status_clean === "Baik" ? "border-green-500" :
    s.status_clean === "Sedang" ? "border-blue-500" :
    s.status_clean === "Tidak Sehat" ? "border-yellow-400" :
    s.status_clean === "Sangat Tidak Sehat" ? "border-pink-500" :
    "border-purple-600";

  container.innerHTML = `
    <div class="bg-white shadow rounded-2xl p-6 border-l-4 ${borderColor}">
      <div class="flex justify-between items-start mb-3">
        <h3 class="font-semibold text-gray-800 text-lg">Detail Stasiun</h3>
        <span class="text-xs px-2 py-1 rounded-full ${
          s.status_clean === 'Baik' ? 'bg-green-100 text-green-700' :
          s.status_clean === 'Sedang' ? 'bg-blue-100 text-blue-700' :
          s.status_clean === 'Tidak Sehat' ? 'bg-yellow-100 text-yellow-700' :
          s.status_clean === 'Sangat Tidak Sehat' ? 'bg-pink-100 text-pink-700' :
          'bg-purple-100 text-purple-700'
        }">${s.status}</span>
      </div>

      <p class="text-sm text-gray-500 mb-1">Lokasi</p>
      <p class="font-semibold text-gray-800 mb-3">${s.name}</p>

      <div class="bg-gray-50 rounded-xl p-4 text-center mb-4 shadow-inner">
        <p class="text-xl text-gray-500">PM<sub>2.5</sub></p>
        <p class="text-4xl font-bold text-green-600">${s.ispu}</p>
        <p class="text-xs text-gray-400"></p>
      </div>

      <p class="font-semibold text-gray-700 mb-2">Nilai Maksimal ISPU Tanggal ${s.tanggal}:</p>
      <br>
      <div class="grid grid-cols-3 gap-2 text-center text-sm mb-5">
        ${gridHTML}
      </div>

      <div class="border-t border-gray-200 pt-3 text-center">
        <a href="#" 
          class="btn-prediksi inline-flex items-center justify2-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
          data-id="${s.id}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.252 2A9.004 9.004 0 006.343 6.343M20 20v-5h-.581M3.5 12a9.003 9.003 0 0015.657 5.657" />
          </svg>
          Lihat Prediksi 7 Hari
        </a>
        <p class="text-xs text-gray-400 mt-1">Prediksi menggunakan model MSSA</p>
      </div>
    </div>
  `;
}


  document.addEventListener("click", e => {
  const btn = e.target.closest(".btn-prediksi");
  if (btn) {
    e.preventDefault();
    const stationId = btn.getAttribute("data-id");
    if (stationId) {
      window.location.href = `/prediksi/${stationId}/`;
    } else {
      alert("ID stasiun tidak ditemukan üò¢");
    }
  }
});

</script>
{% endblock %}