{% extends "base.html" %}
{% block title %}Prediksi Kualitas Udara{% endblock %}
{% block content %}
<section class="py-10 px-4 md:px-6 bg-gray-50 min-h-screen">
  <div class="max-w-5xl mx-auto">

    <a href="{% url 'home' %}" class="text-sm text-gray-500 hover:text-blue-600 flex items-center mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Kembali ke Beranda
    </a>

    <div class="mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
        Prediksi Nilai Maksimum Kualitas Udara Pada Stasiun {{station}}
      </h1>
      <p class="text-gray-600 text-sm mt-1">
        Prediksi kualitas udara 7 hari ke depan menggunakan algoritma MSSA
      </p>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
      <div class="bg-white rounded-lg p-4 text-center shadow-sm border">
        <p class="text-gray-500 text-xs mb-1">Akurasi Model</p>
        <p class="text-2xl font-bold text-green-600">{{ akurasi }}</p>
      </div>
      <div class="bg-white rounded-lg p-4 text-center shadow-sm border">
        <p class="text-gray-500 text-xs mb-1">MAE</p>
        <p class="text-2xl font-bold text-blue-600">{{ mae }}</p>
      </div>
      <div class="bg-white rounded-lg p-4 text-center shadow-sm border">
        <p class="text-gray-500 text-xs mb-1">RMSE</p>
        <p class="text-2xl font-bold text-purple-600">{{ rmse }}</p>
      </div>
      <div class="bg-white rounded-lg p-4 text-center shadow-sm border">
        <p class="text-gray-500 text-xs mb-1">Update Terakhir</p>
        <p class="text-xs text-gray-600">
          {{ last_update|default:"-" }}
        </p>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-4 mb-8">
      <div class="lg:col-span-2 bg-white rounded-lg p-5 shadow-sm border flex flex-col">
        <div class="relative mb-2 px-1 h-6 flex items-center">
          <h3 class="absolute left-1/2 transform -translate-x-1/2 
             font-semibold text-gray-700 text-md">
            Trend Prediksi Polutan
          </h3>

          <div class="ml-auto">
            <select id="selectPolutan" class="border rounded px-3 py-1 text-sm">

              <option value="PM10">PM₁₀</option>
              <option value="PM25" selected>PM₂.₅</option>
              <option value="SO2">SO₂</option>
              <option value="CO">CO</option>
              <option value="O3">O₃</option>
              <option value="NO2">NO₂</option>
              <!-- <option value="ALL">Semua Polutan</option> -->
            </select>
          </div>

        </div>


        <div class="w-full flex-grow h-[240px] md:h-[260px]">
          <canvas id="chartPrediksi" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="flex flex-col gap-3 h-full">
        {% for d in data7hari|slice:":2" %}
        <div class="bg-white p-4 rounded-lg border shadow-sm flex-1">

          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="font-semibold text-sm">
                {% if forloop.first %}Hari Ini{% elif forloop.counter == 2 %}Besok{% else %}{{ d.day }}{% endif %}
              </p>
              <p class="text-xs text-gray-500">{{ d.day }}</p>
            </div>
            <span class="text-[11px] px-2 py-0.5 rounded-full
              {% if d.status == 'Baik' %} bg-green-100 text-green-700
              {% elif d.status == 'Sedang' %} bg-blue-100 text-blue-800
              {% elif d.status == 'Tidak Sehat' %} bg-orange-100 text-orange-700
              {% elif d.status == 'Sangat Tidak Sehat' %} bg-red-100 text-red-700
              {% else %} bg-black text-black {% endif %}">
              {{ d.status }}
            </span>
          </div>

          <p class="text-[11px] text-gray-400 border-t pt-2 mb-1">Prediksi Polutan:</p>
          <div class="grid grid-cols-3 gap-y-1 text-[11px] text-gray-700 text-sm">
            <div>PM<sub>10</sub> <span class="font-semibold">{{ d.pm10 }}</span></div>
            <div>PM<sub>2.5</sub> <span class="font-semibold">{{ d.pm25 }}</span></div>
            <div>SO<sub>2</sub> <span class="font-semibold">{{ d.so2 }}</span></div>
            <div>CO <span class="font-semibold">{{ d.co }}</span></div>
            <div>O<sub>3</sub> <span class="font-semibold">{{ d.o3 }}</span></div>
            <div>NO<sub>2</sub> <span class="font-semibold">{{ d.no2 }}</span></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="bg-white rounded-lg p-5 border shadow-sm mb-8">
      <h2 class="font-semibold text-base mb-4">Prediksi Lengkap 7 Hari - Semua Polutan</h2>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b text-gray-700 text-sm">
              <th class="text-left py-2 px-2">Hari</th>
              <th class="text-center py-2 px-2">PM<sub>10</sub></th>
              <th class="text-center py-2 px-2">PM<sub>2.5</sub></th>
              <th class="text-center py-2 px-2">SO<sub>2</sub></th>
              <th class="text-center py-2 px-2">CO</th>
              <th class="text-center py-2 px-2">O<sub>3</sub></th>
              <th class="text-center py-2 px-2">NO<sub>2</sub></th>
              <th class="text-center py-2 px-2">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for d in data7hari %}
            <tr class="border-b text-sm">
              <td class="py-1 px-2">{{ d.day }}</td>
              <td class="text-center">{{ d.pm10 }}</td>
              <td class="text-center">{{ d.pm25 }}</td>
              <td class="text-center">{{ d.so2 }}</td>
              <td class="text-center">{{ d.co }}</td>
              <td class="text-center">{{ d.o3 }}</td>
              <td class="text-center">{{ d.no2 }}</td>
              <td class="text-center">
                <span class="text-[11px] px-2 py-0.5 rounded-full
                  {% if d.status == 'Baik' %} bg-green-100 text-green-700
                  {% elif d.status == 'Sedang' %} bg-blue-100 text-blue-800
                  {% elif d.status == 'Tidak Sehat' %} bg-orange-100 text-orange-700
                  {% elif d.status == 'Sangat Tidak Sehat' %} bg-red-100 text-red-700
                  {% else %} bg-black text-black {% endif %}">
                  {{ d.status }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="bg-blue-50 border border-blue-100 rounded-lg p-5 mb-8">
      <h3 class="font-semibold text-base mb-4 text-blue-700">Informasi Model MSSA</h3>
      {% if model %}
      <div class="grid md:grid-cols-4 gap-3">
        <div class="bg-white border border-blue-100 rounded-md p-3 text-center">
          <p class="text-blue-600 font-semibold text-lg">{{ l }}</p>
          <p class="text-gray-500 text-xs">Window Length (L)</p>
        </div>
        <div class="bg-white border border-blue-100 rounded-md p-3 text-center">
          <p class="text-blue-600 font-semibold text-lg">{{ k }}</p>
          <p class="text-gray-500 text-xs">Embedding Dimension (K)</p>
        </div>
        <div class="bg-white border border-blue-100 rounded-md p-3 text-center">
          <p class="text-blue-600 font-semibold text-lg">{{ r }}</p>
          <p class="text-gray-500 text-xs">Jumlah Komponen (r)</p>
        </div>
        <div class="bg-white border border-blue-100 rounded-md p-3 text-center">
          <p class="text-blue-600 font-semibold text-lg">{{ p }}</p>
          <p class="text-gray-500 text-xs mt-0.5">Lag Data (p)</p>
        </div>
      </div>
      {% else %}
      <p class="text-gray-500 text-sm text-center mt-3">Belum ada data model MSSA</p>
      {% endif %}
    </div>

  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('chartPrediksi').getContext('2d');

  const colorMap = {
    PM10: '#2563eb',
    PM25: '#16a34a',
    SO2: '#f59e0b',
    CO: '#ef4444',
    O3: '#9333ea',
    NO2: '#0ea5e9'
  };

  let chart = null;
  let dataPolutan = {};
  let labels = [];

  function generateDatasets(selected) {
    return Object.keys(dataPolutan)
      .filter(k => selected === "ALL" || k === selected)
      .map(k => ({
        label: k,
        borderColor: colorMap[k],
        backgroundColor: colorMap[k],
        data: dataPolutan[k],
        tension: 0.3,
        pointRadius: 4,
        pointStyle: 'circle'
      }));
  }

  const apiUrl = "{% url 'prediksi' id_station=station_id %}?format=json";

  fetch(apiUrl, { headers: { "Accept": "application/json" } })
    .then(r => r.json())
    .then(data => {
      console.log("API OK:", data);

      labels = data.labels || [];
      dataPolutan = data.chart_data || {};

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: generateDatasets("PM25")
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "Tanggal Prediksi" } },
            y: { beginAtZero: true, title: { display: true, text: "Nilai ISPU" } }
          }
        }
      });

      document.getElementById("selectPolutan").addEventListener("change", function () {
        chart.data.datasets = generateDatasets(this.value);
        chart.update();
      });
    })
    .catch(err => console.error("Gagal fetch data prediksi:", err));
</script>

{% endblock %}